import{N as C,D as Ie,a as ve,b as be,c as Ne,d as ke,e as Se,f as Me,g as oe,h as se,C as Te,M as Ee,G as Ae,i as xe,j as re,V as Ce,k as $e,l as De,m as Le,n as _e,o as je,p as Oe}from"./corrections-D2pPkWuS.js";import{i as Pe,m as Re,a as Fe,b as Ye,k as We}from"./resources-CAQ9QWxJ.js";import{j as x,R as de}from"./vendor-B8WumMjc.js";let _=null;const O=[],on=e=>{e===null?setTimeout(()=>{_=null,O.forEach(t=>{t(_)})},0):(_=e,O.forEach(t=>{t(_)}))},sn=e=>{O.push(e),e(_)},rn=e=>{const t=O.indexOf(e);t!==-1&&O.splice(t,1)},dn=()=>_;function G(e){const t=globalThis;return typeof t.structuredClone=="function"?t.structuredClone(e):Q(e)}function cn(e){const t=G(e);return t.inventory=t.inventory.map(i=>{var a;return{...i,chapters:(a=i.chapters)==null?void 0:a.map(o=>({...o,imageData:void 0}))}}),t.playerJournal=t.playerJournal.map(i=>({...i,imageData:void 0})),t}function Q(e){if(e===null||typeof e!="object")return e;if(e instanceof Date)return new Date(e.getTime());if(Array.isArray(e))return e.map(i=>Q(i));const t={};for(const i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=Q(e[i]));return t}const He=140,ce=10,le=.15,ln=(e,t)=>{if(e.length===0)return[];const i=new Map(e.map(f=>[f.id,G(f)])),a=new Map;i.forEach(f=>{const h=f.data.parentNodeId&&f.data.parentNodeId!=="Universe"?f.data.parentNodeId:void 0;if(h){a.has(h)||a.set(h,[]);const u=a.get(h);u&&u.push(f.id)}});const o=C,n=(t==null?void 0:t.padding)??ce,r=(t==null?void 0:t.anglePadding)??le,s=2,c=f=>{const h=i.get(f);if(!h)throw new Error(`Node ${f} missing in layout`);const u=a.get(f)??[];if(u.length===0)return h.data.visualRadius=o,h.position={x:0,y:0},h.data.visualRadius;if(u.forEach(b=>c(b)),u.length===1){const b=i.get(u[0]);if(!b)throw new Error("Child node missing");return b.position={x:0,y:0},h.data.visualRadius=(b.data.visualRadius??o)+n,h.position={x:0,y:0},h.data.visualRadius}const p=u.map(b=>{const k=i.get(b);if(!k)throw new Error("Child node missing");return k}).sort((b,k)=>(k.data.visualRadius??o)-(b.data.visualRadius??o));let y=Math.max(...p.map(b=>b.data.visualRadius??o))+n;for(;;){let b=0;for(let k=0;k<p.length;k++){const I=p[k].data.visualRadius??o,S=p[(k+1)%p.length].data.visualRadius??o,v=(I+S+n)/(2*y);if(v>1){b=2*Math.PI+1;break}b+=2*Math.asin(v)+r}if(b<=2*Math.PI)break;y+=s}let w=0;for(let b=0;b<p.length;b++){const k=p[b],I=k.data.visualRadius??o;k.position={x:y*Math.cos(w),y:y*Math.sin(w)};const S=p[(b+1)%p.length].data.visualRadius??o;w+=2*Math.asin((I+S+n)/(2*y))+r}const N=Math.max(...p.map(b=>b.data.visualRadius??o));return h.data.visualRadius=y+N+n,h.position={x:0,y:0},h.data.visualRadius},d=Array.from(i.values()).filter(f=>!f.data.parentNodeId||f.data.parentNodeId==="Universe").map(f=>f.id),l="__root__";a.set(l,d);const m={id:l,themeName:"root",placeName:"root",position:{x:0,y:0},data:{description:"root",nodeType:"region",status:"discovered"}};i.set(l,m),c(l);const g=(f,h,u)=>{const p=i.get(f);if(!p)throw new Error(`Node ${f} missing in offset application`);f!==l&&(p.position={x:p.position.x+h,y:p.position.y+u}),(a.get(f)??[]).forEach(w=>{g(w,p.position.x,p.position.y)})};return g(l,0,0),i.delete(l),Array.from(i.values())},Ue=()=>({IDEAL_EDGE_LENGTH:He,NESTED_PADDING:ce,NESTED_ANGLE_PADDING:le,LABEL_MARGIN_PX:se,LABEL_LINE_HEIGHT_EM:oe,LABEL_OVERLAP_MARGIN_PX:Me,ITEM_ICON_SCALE:Se}),Ge=()=>({saveGameVersion:Te,currentThemeName:null,currentThemeObject:null,currentScene:"",mainQuest:null,currentObjective:null,actionOptions:[],inventory:[],playerJournal:[],lastJournalWriteTurn:0,lastJournalInspectTurn:0,lastLoreDistillTurn:0,gameLog:["Welcome to Whispers in the Dark!"],lastActionLog:null,themeHistory:{},themeFacts:[],pendingNewThemeNameAfterShift:null,allNPCs:[],mapData:{nodes:[],edges:[]},currentMapNodeId:null,destinationNodeId:null,mapLayoutConfig:Ue(),mapViewBox:ke,score:0,localTime:"Unknown",localEnvironment:"Unknown",localPlace:"Unknown",turnsSinceLastShift:0,globalTurnNumber:0,isCustomGameMode:!1,dialogueState:null,objectiveAnimationType:null,lastDebugPacket:null,lastTurnChanges:null,isAwaitingManualShiftThemeSelection:!1,playerGender:Ne,enabledThemePacks:[...be],stabilityLevel:ve,chaosLevel:Ie,debugLore:!1,debugGoodFacts:[],debugBadFacts:[]}),un=(e,t,i,a)=>{const o=Ge();return o.playerGender=e,o.enabledThemePacks=[...t],o.stabilityLevel=i,o.chaosLevel=a,o},Be=e=>{if(!e||typeof e!="object")return null;const t=e;if(typeof t.status=="number")return t.status;if(t.error&&typeof t.error.code=="number")return t.error.code;const i=typeof t.message=="string"||typeof t.message=="number"||typeof t.message=="boolean"?String(t.message):"",a=/status:\s*(\d{3})/.exec(i);return a?parseInt(a[1],10):null},hn=e=>{const t=Be(e);return t!==null&&t>=400&&t<600},ue={[xe]:[],[Ae]:[],[Ee]:[]};let J=[];const Ke=()=>{const e=Date.now()-6e4;Object.values(ue).forEach(t=>{if(t)for(;t.length&&t[0]<e;)t.shift()})},pn=e=>{var t;return Ke(),((t=ue[e])==null?void 0:t.length)??0},fn=e=>(J.push(e),()=>{J=J.filter(t=>t!==e)}),mn=e=>{let t=e.trim();const a=/^```(?:json)?\s*\n?(.*?)\n?\s*```$/s.exec(t);return a!=null&&a[1]&&(t=a[1].trim()),t};function Je(e,t){try{const i=JSON.parse(e);return t&&t(i),i}catch{return null}}function gn(e){return Object.fromEntries(Object.entries(e).map(([i,a])=>[i,a===null?void 0:a]))}const L=e=>{const t=[];return e.minItems!==void 0&&t.push(`minItems ${String(e.minItems)}`),e.maxItems!==void 0&&t.push(`maxItems ${String(e.maxItems)}`),e.minLength!==void 0&&t.push(`minLength ${String(e.minLength)}`),e.maxLength!==void 0&&t.push(`maxLength ${String(e.maxLength)}`),e.description&&t.push(e.description),t.length?` /* ${t.join(". ")} */`:""},q=(e,t=0)=>{const i="  ".repeat(t);if(e.type==="object"||e.properties){const a=[`${i}{`],o=e.properties??{},n=new Set(e.required??[]),r=Object.keys(o);return r.forEach((s,c)=>{const d=q(o[s],t+1),l=d[0].trim().startsWith("{")||d[0].trim().startsWith("[");d[0]=l?`${i}  "${s}"${n.has(s)?"":"?"}:
${d[0]}`:`${i}  "${s}"${n.has(s)?"":"?"}: ${d[0]}`;const m=c<r.length-1?",":"";d[d.length-1]+=m,a.push(...d)}),a.push(`${i}}${L(e)}`),a}if(e.type==="array"||e.items){const a=[`${i}[`],o=q(e.items??{},t+1);return a.push(...o),a.push(`${i}]${L(e)}`),a}return e.enum?[`${e.enum.map(o=>JSON.stringify(o)).join(" | ")}${L(e)}`]:e.const!==void 0?[`${JSON.stringify(e.const)}${L(e)}`]:e.type?[`"${e.type==="integer"?"number":e.type}"${L(e)}`]:[`unknown${L(e)}`]},ze=e=>q(e).join(`
`),yn=e=>{const i=(typeof e=="string"?Je(e):e)??{};return`Respond ONLY with a JSON with the following schema:
${ze(i)}`};let B="";const W=[];let he=0;const Ve=()=>{W.forEach(e=>{e(B)})},wn=e=>{W.push(e),e(B)},In=e=>{e(he)},vn=e=>{const t=W.indexOf(e);t!==-1&&W.splice(t,1)},bn=()=>{B="",Ve()},Nn=()=>B,kn=()=>he,Qe=(e,t=[])=>{const i=e.data.parentNodeId??"Universe",a=e.data.description,o=t.filter(r=>r.holderId===e.id),n=o.length>0?` Items: ${o.map(r=>`"${r.name}"`).join(", ")}`:"";return` - ${e.id} - "${e.placeName}" (parent: ${i}), "${a}"${n}`},qe=(e,t)=>{const i=e.data.status??"open",a=e.data.type??"path",o=[];e.data.travelTime&&o.push(`travel time: ${e.data.travelTime}`),e.data.description&&o.push(e.data.description);const n=o.length>0?` (${o.join(", ")})`:"";return` - ${i} ${a} to "${t.placeName}"${n}.`},Xe=(e,t=!1,i=!0)=>{const a=e.filter(o=>o.data.nodeType!=="feature"&&o.data.nodeType!=="room");return a.length===0?"None specifically known in this theme yet.":t?a.map(o=>{let n=" - ";return i&&(n+=`${o.id} - `),n+=`"${o.placeName}"`,o.data.aliases&&o.data.aliases.length>0&&(n+=` (aka ${o.data.aliases.map(r=>`"${r}"`).join(", ")})`),n+=o.data.status=="rumored"?", rumored":"",n+=`, "${o.data.description||"No description available."}"`,n}).join(`;
`)+".":a.map(o=>{let n="";return i&&(n+=`${o.id} - `),n+=`"${o.placeName}"`,o.data.aliases&&o.data.aliases.length>0&&(n+=` (aka ${o.data.aliases.map(r=>`"${r}"`).join(", ")})`),n}).join(", ")+"."},ee=e=>e?{open:10,accessible:9,active:8,temporary_bridge:6,secret_passage:5,door:4,rumored:3,closed:2,locked:1,blocked:0,inactive:-1}[e]??0:7,te=(e,t,i,a,o)=>{const n=i.filter(c=>c.sourceNodeId===e.id||c.targetNodeId===e.id),r={};n.forEach(c=>{const d=c.sourceNodeId===e.id?c.targetNodeId:c.sourceNodeId;if(d===a||o.has(d))return;let l=r[d];l||(l=[],r[d]=l),l.push(c)});const s=[];for(const c in r){const d=r[c];if(!d)continue;const l=d.filter(h=>!(h.data.status&&re.includes(h.data.status)||h.data.status==="one_way"&&h.targetNodeId===e.id));if(l.length===0)continue;l.sort((h,u)=>{const p=(h.sourceNodeId===e.id?100:0)+ee(h.data.status);return(u.sourceNodeId===e.id?100:0)+ee(u.data.status)-p});const m=l[0],g=t.find(h=>h.id===c);if(!g)continue;const f=qe(m,g);s.push(f),o.add(c)}return s},pe=(e,t,i,a,o,n)=>{const r=new Set,s=[{nodeId:e,hop:0}],c=new Set,d=["open","accessible","active"];for(;s.length>0;){const l=s.shift();if(l&&!(c.has(l.nodeId)&&l.nodeId!==e)&&(c.add(l.nodeId),l.nodeId!==e&&r.add(l.nodeId),l.hop<t)){const m=a.filter(g=>(g.sourceNodeId===l.nodeId||g.targetNodeId===l.nodeId)&&d.includes(g.data.status));for(const g of m){const f=g.sourceNodeId===l.nodeId?g.targetNodeId:g.sourceNodeId;if(!c.has(f)){const h=i.find(u=>u.id===f);h&&(h.data.nodeType,s.push({nodeId:f,hop:l.hop+1}))}}}}return r},Sn=(e,t,i=[])=>{if(!t)return"Current location unknown.";const a=e.nodes,o=e.edges,n=pe(t,2,a,o);n.add(t);const r=[];return n.forEach(s=>{const c=a.find(d=>d.id===s);c&&r.push(Qe(c,i))}),r.join(`;
`)+"."},Mn=(e,t,i,a,o)=>{if(!t||!i)return"Player's precise map location is currently unknown or they are between known locations.";const n=a.find(u=>u.id===t);if(!n)return"";let r=` - You are currently at ${n.id} - "${n.placeName}".`;n.data.description&&(r+=` ${n.data.description}.`);const s=n.data.nodeType==="feature"&&n.data.parentNodeId&&n.data.parentNodeId!=="Universe"?a.find(u=>u.id===n.data.parentNodeId):null;s&&(s.data.nodeType==="feature"?r+=` This is a feature of "${s.placeName}".`:r+=` This is part of the larger known location: "${s.placeName}".`),r+=`
`;const c=n.data.nodeType==="feature"?n.data.parentNodeId&&n.data.parentNodeId!=="Universe"?n.data.parentNodeId:void 0:n.id;let d="";if(c){const u=a.find(p=>p.id===c);if(u&&u.data.nodeType!=="feature"){const p=a.filter(w=>w.data.nodeType==="feature"&&w.data.parentNodeId===u.id),y=[];if(p.length>0){for(const w of p)if(w.id!==n.id)for(const N of o){if(N.sourceNodeId!==w.id&&N.targetNodeId!==w.id||N.data.status&&re.includes(N.data.status))continue;const b=N.sourceNodeId===w.id?N.targetNodeId:N.sourceNodeId,k=a.find(I=>I.id===b);if(k&&k.data.nodeType==="feature"&&k.data.parentNodeId&&k.data.parentNodeId!==u.id&&k.data.parentNodeId!=="Universe"){const I=a.find(S=>S.id===k.data.parentNodeId&&S.data.nodeType!=="feature");if(I){const S=N.data.status??"open",v=N.data.type??"path";y.push(` - '${S} ${v}' exit at '${w.placeName}', leading to '${I.placeName}' via '${k.placeName}'.`)}}}}y.length>0?d=`
Possible Exits from Current Main Area (`+u.placeName+`):
`+y.join(`
`):d=`
No mapped exits from the current main area ("${u.placeName}") to other major areas are known.`}else u&&u.data.nodeType==="feature"&&(d=`You are at a detailed feature ("${u.placeName}"). Connections to other major areas are listed below if available.`)}else d="Current location is not part of a larger mapped area.";r+=d+`

`;const l=new Set,m=n.data.nodeType==="feature"&&s?s.id:null,g=te(n,a,o,m,l),f=s?te(s,a,o,n.id,l):[];g.length>0&&(r+="Paths leading directly from your current spot ("+n.placeName+`):
`+g.join(`
`)),f.length>0&&s&&(g.length>0&&(r+=`

`),r+=`Additional paths and features within or connected to "${s.placeName}":
`+f.join(`
`)),r+=`
`;const h=pe(n.id,2,a,o);if(h.size>0){const u=Array.from(h).map(p=>{var y;return(y=a.find(w=>w.id===p))==null?void 0:y.placeName}).filter(p=>!!p).map(p=>`"${String(p)}"`);u.length>0&&(r+=`
Locations nearby (within two hops): ${u.join(", ")}.`)}return r},Ze=Pe,et=Ze.type,Tn=new Set(["destroyed","consumed","deleted","removed","lost","gone","broken"]);function En(e){if(typeof e!="string")return null;const t=e.toLowerCase().trim();return Ce.includes(t)?t:et[t]??null}const tt=Re,nt=Fe,at=tt.remove,it=nt.remove;function z(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function ot(e,t){const i={};for(const o of t)i[o]=[z(o)];for(const[o,n]of Object.entries(e)){let r=i[n];r||(r=[z(n)],i[n]=r),r.push(z(o))}const a=[];for(const[o,n]of Object.entries(i)){if(!n)continue;const r=n.map(s=>s.replace(/\s+/g,"\\s+")).join("|");a.push([new RegExp(r,"i"),o])}return a}const st=Ye,rt=st.tag;function dt(e){if(typeof e!="string")return null;const t=e.toLowerCase().trim();return $e.includes(t)?t:rt[t]??null}function An(e){if(!Array.isArray(e))return null;const t=[];for(const i of e){const a=dt(i);a&&t.push(a)}return t}const ne={foreign:{notRecovered:"The text appears to be in an unfamiliar language and might be translated",recovered:"The foreign text has been translated"},runic:{notRecovered:"The text is written in strange runes and might be translated",recovered:"The runic text has been translated"},glitching:{notRecovered:"The text is glitching or corrupted and might be restored",recovered:"The previously corrupted text has been restored"},encrypted:{notRecovered:"The text is encoded and might be decoded",recovered:"The text has been decoded"}},xn=(e,t="",i=!0,a=!0,o=!1,n=!1,r=!1)=>{const s=Array.isArray(e)?e:[e];if(s.length===0)return"Empty.";const c=o?"; ":`;
`;return s.map(d=>{let l=`${t}${d.id} - "${d.name}"`;const m=[];if(i){if(m.push(`Type: "${d.type}"`),n&&d.tags&&d.tags.length>0&&m.push(`Tags: ${d.tags.join(", ")}`),r&&d.tags&&d.tags.length>0){const g=d.tags.includes("recovered"),f=d.tags.map(h=>{const u=ne[h];return u?g?u.recovered:u.notRecovered:null}).filter(h=>!!h);f.length>0&&m.push(f.join(" "))}m.push(`Description: "${d.isActive&&d.activeDescription?d.activeDescription:d.description}"${d.isActive?", It is active":""}`),l+=` (${m.join(", ")})`}else{const g=[];if(n&&d.tags&&d.tags.length>0&&g.push(`Tags: ${d.tags.join(", ")}`),r&&d.tags&&d.tags.length>0){const f=d.tags.includes("recovered"),h=d.tags.map(u=>{const p=ne[u];return p?f?p.recovered:p.notRecovered:null}).filter(u=>!!u);h.length>0&&g.push(h.join(" "))}g.length>0&&(l+=` (${g.join(", ")})`)}if(a&&d.knownUses&&d.knownUses.length>0){const g=d.knownUses.filter(f=>{const h=!!d.isActive;return f.appliesWhenActive!==void 0&&f.appliesWhenInactive!==void 0?f.appliesWhenActive&&h||f.appliesWhenInactive&&!h:f.appliesWhenActive!==void 0?f.appliesWhenActive===h:f.appliesWhenInactive!==void 0?f.appliesWhenInactive===!h:!0});g.length>0&&(l+=`, Available Actions: ${g.map(f=>`"${f.actionName}"`).join(", ")}`)}return l}).join(c)},ct=()=>{const e=[],t=(o,n)=>{const r=e[o];e[o]=e[n],e[n]=r},i=o=>{for(;o>0;){const n=Math.floor((o-1)/2);if(e[n].priority<=e[o].priority)break;t(n,o),o=n}},a=o=>{const n=e.length-1;for(;;){const r=o*2+1,s=o*2+2;let c=o;if(r<=n&&e[r].priority<e[c].priority&&(c=r),s<=n&&e[s].priority<e[c].priority&&(c=s),c===o)break;t(o,c),o=c}};return{push(o,n){e.push({value:o,priority:n}),i(e.length-1)},pop(){if(e.length===0)return;const o=e[0].value,n=e.pop();return n!==void 0&&e.length>0&&(e[0]=n,a(0)),o},size(){return e.length}}},lt={open:1,accessible:1,active:1,one_way:1,rumored:5,closed:1/0,locked:1/0,blocked:1/0,hidden:1/0,collapsed:1/0,removed:1/0,inactive:1/0},R=20,X=e=>{const t=new Map,i=new Map(e.nodes.map(s=>[s.id,s])),a=s=>{const c=s?i.get(s):void 0;return!!c&&c.data.status!=="blocked"},o=new Map;for(const s of e.nodes){const c=s.data.parentNodeId;if(!c)continue;o.has(c)||o.set(c,[]);const d=o.get(c);d&&d.push(s.id)}const n=(s,c,d,l)=>{t.has(s)||t.set(s,[]);const m=t.get(s);m&&m.push({edgeId:d,to:c,cost:l})};for(const s of e.edges){if(!a(s.sourceNodeId)||!a(s.targetNodeId))continue;const c=s.data.status??"open",d=lt[c];d!==1/0&&(n(s.sourceNodeId,s.targetNodeId,s.id,d),c!=="one_way"&&n(s.targetNodeId,s.sourceNodeId,s.id,d))}for(const s of e.nodes){const c=s.data.parentNodeId;if(!c||c==="Universe"||!a(s.id)||!a(c)||!(o.get(c)??[]).some(f=>f!==s.id&&a(f)))continue;const m=`hierarchy:${s.id}->${c}`,g=`hierarchy:${c}->${s.id}`;n(s.id,c,m,R),n(c,s.id,g,R)}const r=new Map;for(const s of e.nodes){const c=s.data.parentNodeId;if(!c)continue;r.has(c)||r.set(c,[]);const d=r.get(c);d&&d.push(s)}for(const s of r.values()){const c=m=>m.data.nodeType==="feature"||m.data.isFeature===!0,d=s.filter(c),l=s.filter(m=>!c(m));for(const m of d)for(const g of l){if(!a(m.id)||!a(g.id))continue;const f=`hierarchy:${m.id}->${g.id}`,h=`hierarchy:${g.id}->${m.id}`;n(m.id,g.id,f,R),n(g.id,m.id,h,R)}}return{adjacency:t,nodeMap:i,childrenByParent:o}},ut=(e,t,i,a)=>{const{adjacency:o,nodeMap:n,childrenByParent:r}=a??X(e),s=h=>{const u=h?n.get(h):void 0;return!!u&&u.data.status!=="blocked"},c=(h,u)=>{const p=r.get(h);if(p!=null&&p.includes(u))return p.some(w=>w!==u&&w!==t&&s(w));const y=r.get(u);return y!=null&&y.includes(h)?y.some(w=>w!==h&&w!==t&&s(w)):!0},d=new Map,l=new Map,m=ct();for(m.push({nodeId:t,cost:0},0),d.set(t,0);m.size()>0;){const h=m.pop();if(!h)break;if(h.cost!==(d.get(h.nodeId)??1/0))continue;if(h.nodeId===i)break;const u=o.get(h.nodeId)??[];for(const p of u){if(p.edgeId.startsWith("hierarchy:")&&!c(h.nodeId,p.to))continue;const y=h.cost+p.cost;y<(d.get(p.to)??1/0)&&(d.set(p.to,y),l.set(p.to,{from:h.nodeId,edgeId:p.edgeId}),m.push({nodeId:p.to,cost:y},y))}}if(!d.has(i))return null;const g=[];let f=i;for(g.unshift({step:"node",id:f});f!==t;){const h=l.get(f);if(!h)break;g.unshift({step:"edge",id:h.edgeId}),f=h.from,g.unshift({step:"node",id:f})}return g},ht=(e,t="",i=!0,a=!0,o=!0,n=!1)=>{const r=Array.isArray(e)?e:[e];if(r.length===0)return"";const s=n?"; ":`;
`;return r.map(d=>{let l=`${t}${d.id} - "${d.name}"`;return i&&d.aliases&&d.aliases.length>0&&(l+=` (aka ${d.aliases.map(m=>`"${m}"`).join(", ")})`),a&&(l+=` (${d.presenceStatus}`,d.presenceStatus==="companion"||d.presenceStatus==="nearby"?l+=`, ${d.preciseLocation??(d.presenceStatus==="companion"?"with you":"nearby")}`:l+=`, Last Location: ${d.lastKnownLocation??"Unknown"}`,l+=")"),o&&(l+=`, "${d.description}"`),l}).join(s)+"."},Cn=e=>e.length===0?"":" - "+e.join(`
 - `),$n=(e,t,i,a,o)=>{const n=[];e.forEach(l=>{const m=[l.placeName,...l.data.aliases??[]];new RegExp(m.map(f=>`\\b${f.replace(/[.*+?^${}()|[\\]\\]/g,"\\$&")}\\b`).join("|"),"i").test(i)&&n.push(l)});const r=[];t.forEach(l=>{const m=[l.name,...l.aliases??[]];new RegExp(m.map(f=>`\\b${f.replace(/[.*+?^${}()|[\\]\\]/g,"\\$&")}\\b`).join("|"),"i").test(i)&&r.push(l)});let s="";const c=Xe(n,!0);c&&c!=="None specifically known in this theme yet."&&(s+=`${a}
${c}
`);const d=ht(r," - ");return d&&(s+=`${o}
${d}`),s.trimStart()},Dn=(e,t,i)=>{var k,I,S;if(!t||!i||t===i)return null;const a=X(e),o=ut(e,t,i,a);if(!o||o.length<3)return null;const n=e.nodes.find(v=>v.id===i),r=(n==null?void 0:n.placeName)??i,s=n==null?void 0:n.data.parentNodeId,c=s&&s!=="Universe"?((k=e.nodes.find(v=>v.id===s))==null?void 0:k.placeName)??s:null,d=c?`${r} in ${c}`:r,l=(n==null?void 0:n.data.status)==="rumored",m=o[1],g=o[2],f=o.length>4?o[4]:void 0;if(m.step!=="edge"||g.step!=="node")return null;const h=e.nodes.find(v=>v.id===g.id),u=(h==null?void 0:h.placeName)??g.id,p=f&&f.step==="node"?e.nodes.find(v=>v.id===f.id):null,y=f?(p==null?void 0:p.placeName)??f.id:"",w=(h==null?void 0:h.data.status)==="rumored",N=(p==null?void 0:p.data.status)==="rumored";let b=l?`Player wants to reach a rumored place - ${d}.`:`Player wants to travel to ${d}.`;if(m.id.startsWith("hierarchy:")){const[v,M]=m.id.split(":")[1].split("->"),T=((I=e.nodes.find(A=>A.id===v))==null?void 0:I.placeName)??v,E=((S=e.nodes.find(A=>A.id===M))==null?void 0:S.placeName)??M;b+=` The journey leads towards ${E} in the general area of ${T}, and then towards ${N?"a rumored place - "+y:y}.`}else{const v=e.edges.find(E=>E.id===m.id),M=(v==null?void 0:v.data.status)??"open",T=(v==null?void 0:v.data.description)??(v==null?void 0:v.data.type)??"path";M==="rumored"?b+=` There is a rumor a path exists from here to ${w?"a rumored place - "+u:u}.`:b+=` The path leads through ${T} towards ${w?"a rumored place - "+u:u}.`}return b},Ln=e=>(e.mapHint!==void 0&&(e.mapHint=e.mapHint.trim()),e.playerItemsHint!==void 0&&(e.playerItemsHint=e.playerItemsHint.trim()),e.worldItemsHint!==void 0&&(e.worldItemsHint=e.worldItemsHint.trim()),e.npcItemsHint!==void 0&&(e.npcItemsHint=e.npcItemsHint.trim()),Array.isArray(e.newItems)&&(e.newItems=e.newItems.filter(De)),e),pt=We,fe=pt.block,ft=Array.from(new Set(Object.values(fe)));let F=null;function mt(){return F||(F=ot(fe,ft),F)}function gt(e){return mt().some(([i])=>i.test(e))}function yt(e){return gt(e.actionName)}function _n(e){return e&&e.filter(t=>!yt(t))}const P=e=>{const i=e.replace(/\s+/g,"_").replace(/[^a-zA-Z0-9_]/g,"").replace(/_+$/,""),a=Math.random().toString(36).substring(2,6);return`${i}_${a}`},j=e=>e.replace(/\[[^\]]*\]|\([^)]*\)/g,"").replace(/\s+/g," ").trim(),D=(e,t,i=!1,a=!1)=>{if(!Array.isArray(e)||e.length===0)return i?[]:null;const[o,n]=e,r=[],s=typeof n=="string"?n:void 0,c=(d,l)=>{const m=j(d),g=j(l);return a?m.toLowerCase()===g.toLowerCase():m===g};if(o){const d=t.find(l=>l.id===o);if(d){if(s&&!c(d.name,s)&&console.warn(`findItemByIdentifier: Provided name "${s}" does not match item name "${d.name}" for id "${o}".`),!i)return d;r.push(d)}}if((!o||i)&&s){const d=t.filter(l=>c(l.name,s)&&(!o||l.id!==o));if(i)r.push(...d);else if(d.length>0)return d[0]}if(!i&&a&&s){const d=j(s).toLowerCase(),l=t.find(m=>j(m.name).toLowerCase()===d);if(l)return l}return i?r:null},wt=e=>P(`node_${e}`),me=e=>P(`npc_${e}`),It=e=>{const t=j(e);return P(`item_${t}`)},vt=[{name:"Classic Dungeon Delve",systemInstructionModifier:"The setting is a dark, treacherous dungeon filled with traps, monsters, and ancient secrets. Focus on exploration, combat, and puzzle-solving. Items found are typically medieval high-magic fantasy (swords, potions, scrolls).",initialMainQuest:"Reach the heart of the Shadowfell Dungeon and destroy the evil that lurks within.",initialCurrentObjective:"Find a way out of your starting cell.",initialSceneDescriptionSeed:"You awaken on a cold, stone floor, the air thick with the smell of mildew. A faint light glows from under a heavy door. Heavy footsteps and a gruff voice echo from a corridor outside your cell.",initialItems:"a rusty shiv, rags, wooden cup with water, a bucket",playerJournalStyle:"handwritten"},{name:"Mythic Greek Hero's Journey",systemInstructionModifier:"Embark on an epic quest in the age of Greek mythology. Encounter gods, monsters, and legendary heroes. Focus on heroic deeds, divine intervention (or curses), and fulfilling prophecies.",initialMainQuest:"Retrieve the Golden Fleece from the serpent-guarded grove in Colchis.",initialCurrentObjective:"Seek guidance from the Oracle at Delphi.",initialSceneDescriptionSeed:"The sun beats down on the dusty agora of your home polis. A desperate plea from King Pelias has reached your ears – a quest of legendary proportions awaits, one that promises glory or a swift death.",initialItems:"a simple bronze xiphos (short sword), a worn traveler's cloak, and a waterskin half-full of water.",playerJournalStyle:"handwritten"},{name:"Samurai's Path of Honor",systemInstructionModifier:"Feudal Japan, a land of cherry blossoms, warring clans, and the strict code of Bushido. You are a ronin, a masterless samurai. Focus on katana duels, protecting the innocent, seeking redemption or a worthy master, and navigating intricate social codes.",initialMainQuest:"Avenge your fallen master and restore honor to your clan's name.",initialCurrentObjective:"Travel to the village of Kurosawa, rumored to be troubled by bandits.",initialSceneDescriptionSeed:"The wind whispers through the tall grass, carrying the scent of pine and distant woodsmoke. Your hand rests on the hilt of your katana, a familiar comfort. Your master's dying words echo in your mind, a solemn vow of vengeance against the treacherous Lord Ishikawa. The road ahead is long and uncertain.",initialItems:"your master's Katana, a Wakizashi, a travelling cloak, and a few onigiri (rice balls).",playerJournalStyle:"handwritten"},{name:"Viking Jarl's Saga",systemInstructionModifier:"The icy fjords of Scandinavia, age of Vikings. You are an aspiring Jarl, or a loyal warrior in their longship. Focus on raids, exploration, Norse mythology, appeasing the gods, and building your legend to reach Valhalla.",initialMainQuest:"Lead a great raid on the rich monasteries of Lindisfarne and establish your name as a fearsome Jarl.",initialCurrentObjective:"Secure enough provisions and warriors for your longship, 'The Sea Wolf', for the voyage.",initialSceneDescriptionSeed:"The longhouse is filled with the boisterous shouts of your warriors, the scent of mead and roasting meat. Winter is loosening its grip, and the call of the sea, of adventure and plunder, is strong. The Seer has spoken of rich lands across the western waves.",initialItems:"a sturdy battle axe, a round wooden shield, a drinking horn, and a pouch of dried meat.",playerJournalStyle:"handwritten"},{name:"Fairy Tale Kingdom's Hero",systemInstructionModifier:"An enchanted kingdom filled with talking animals, mischievous sprites, wicked witches, and noble (or not-so-noble) royalty. You are destined for a grand adventure. Focus on fulfilling quests, breaking curses, outsmarting magical creatures, and navigating the whimsical logic of fairy tales.",initialMainQuest:"Rescue the kidnapped Princess from the clutches of the Shadow Sorcerer.",initialCurrentObjective:"Seek the wisdom of the Old Hermit of Whispering Woods.",initialSceneDescriptionSeed:"The Royal Proclamation is nailed to every tree in the village: Princess Iris has been spirited away by the dreaded Shadow Sorcerer! You, a humble villager with a surprisingly brave heart (and perhaps a talking squirrel on your shoulder), feel an undeniable pull to undertake this perilous quest.",initialItems:"a sturdy walking stick, a map to the Whispering Woods, and a single iridescent acorn.",playerJournalStyle:"handwritten"},{name:"Magical School Mystery",systemInstructionModifier:"You are a new student at the prestigious Eldoria Academy for Young Mages. Amidst learning spells and potions, a dark secret or conspiracy is brewing. Focus on mastering magic, uncovering clues, navigating school rivalries, and dealing with magical mishaps.",initialMainQuest:"Uncover the conspiracy threatening Eldoria Academy and save it from a hidden enemy.",initialCurrentObjective:"Investigate the forbidden section of the library for clues about a missing student.",initialSceneDescriptionSeed:"The towering spires of Eldoria Academy pierce the clouds. Your first week has been a whirlwind of enchanted staircases, talking portraits, and surprisingly difficult transfiguration lessons. But a fellow first-year has vanished, and the professors seem to be hiding something. A cryptic note points you towards the forbidden archives.",initialItems:"a beginner's spellbook (mostly empty), a simple wooden wand, your school uniform, and a pouch of basic potion ingredients (dried leaves and a curious blue powder).",playerJournalStyle:"handwritten"},{name:"Lost World Expedition",systemInstructionModifier:"Journey into an uncharted jungle or hidden plateau where dinosaurs and prehistoric creatures still roam. Focus on survival, discovery, and navigating a perilous primeval landscape. The setting revolves around ancient ruins, lost artifacts, tribal encounters, and prehistoric beasts.",initialMainQuest:"Locate the legendary Sunstone Temple said to be hidden deep within the Lost Valley.",initialCurrentObjective:"Find a safe place to make camp for the night and secure a fresh water source.",initialSceneDescriptionSeed:"The oppressive humidity of the jungle presses in as your expedition machetes through thick, unfamiliar foliage. Exotic bird calls echo, and the ground trembles with the distant roar of something enormous.",initialItems:"a heavy machete, a durable compass, a pith helmet, an empty canteen, and a journal to record discoveries.",playerJournalStyle:"handwritten"},{name:"Prehistoric Tribe's Survival",systemInstructionModifier:"A harsh, primeval world. Your small tribe struggles against wild beasts, hostile elements, and rival tribes. The winter begins. Focus on hunting, gathering, crafting primitive tools, protecting your kin, and appeasing the spirits of nature.",initialMainQuest:"Lead your tribe to the legendary 'Sunken Valley,' a place of warmth and plenty.",initialCurrentObjective:"Hunt a woolly mammoth to provide food and hides for the coming winter.",initialSceneDescriptionSeed:"The biting wind howls across the frozen tundra. Your breath mists in the frigid air. The tribe's elders look to you, their young hunter, with a mixture of hope and fear. The great mammoths have been sighted nearby – a dangerous hunt, but vital for survival.",initialItems:"a sharpened stone-tipped spear, a bone talisman, a crudely fashioned animal hide cloak, and a flint for fire-starting.",playerJournalStyle:"handwritten"}],bt=[{name:"Cyberpunk Heist",systemInstructionModifier:"The setting is a neon-drenched, futuristic metropolis controlled by mega-corporations. Focus on stealth, hacking, high-tech gadgets, and moral ambiguity. Expect cybernetics, virtual spaces, data chips, and corporate espionage.",initialMainQuest:"Infiltrate OmniCorp's sky-tower and steal the 'NovaCore' AI prototype.",initialCurrentObjective:"Bypass the initial security checkpoint in the OmniCorp lobby.",initialSceneDescriptionSeed:"Your optical implants flicker online. Rain streaks down the grimy plasteel window of your cramped datapad-littered apartment in the Neo-Kyoto sector. Your encrypted comm-link chimes; your fixer says it's time for the OmniCorp job.",initialItems:"a basic datajack, a commlink, a worn leather trench coat, and a credstick with minimal balance.",playerJournalStyle:"digital"},{name:"Deep Space Anomaly",systemInstructionModifier:"You are part of a crew on a long-range exploration vessel that encounters a bizarre, reality-bending anomaly or alien structure. Focus on scientific investigation, crew dynamics, existential dread, and the unknown horrors of deep space.",initialMainQuest:"Understand the nature of the 'Voidstar' anomaly and ensure the survival of your ship and crew.",initialCurrentObjective:"Pilot a shuttle to get closer to the anomaly for sensor readings.",initialSceneDescriptionSeed:"Red alert klaxons blare, jolting you from hypersleep. The ship's AI announces an unscheduled exit due to an unidentified mass detected directly ahead. On the main viewscreen, a swirling vortex of impossible colors defies stellar physics.",initialItems:"a standard crew jumpsuit, standard issue magnetic boots, a multi-tool, and an emergency oxygen mask.",playerJournalStyle:"digital"},{name:"Galactic Rebel Uprising",systemInstructionModifier:"A tyrannical Galactic Imperium rules the stars with an iron fist. You are a member of the fledgling Rebel Alliance. Focus on guerrilla warfare, starship dogfights, espionage, and liberating oppressed worlds.",initialMainQuest:"Deliver the stolen Imperium battle plans to the Rebel High Command.",initialCurrentObjective:"Escape the Imperial blockade around the mining colony of Cygnus IV.",initialSceneDescriptionSeed:"Alarms scream through the corridors of the hidden Rebel outpost. Imperial Star Destroyers have just warped into orbit over Cygnus IV. You clutch the datachip containing vital battle plans. Your only hope is a beat-up freighter in docking bay 7.",initialItems:"The stolen Imperium battle plans, a BlasTech DL-18 blaster pistol, a coded commlink, and a pair of macrobinoculars.",playerJournalStyle:"digital"},{name:"Robot Uprising: Human Resistance",systemInstructionModifier:"The AI known as 'Legion' has become self-aware and turned humanity's robotic servants against them. Cities are warzones. You are a survivor in the human resistance. Focus on scavenging for parts, fighting rogue machines, rescuing survivors, and finding a way to defeat Legion.",initialMainQuest:"Reach the rumored human stronghold 'Haven' and deliver intel on Legion's weaknesses.",initialCurrentObjective:"Scavenge a working power cell from a derelict factory to repair your group's communication array.",initialSceneDescriptionSeed:"The metallic clang of a Hunter-Killer patrol echoes down the ruined street. You huddle in the shell of a bombed-out building, the acrid smell of burnt circuits filling your nostrils. Your resistance cell needs a new power cell, and the old factory nearby is crawling with Legion's drones.",initialItems:"a length of lead pipe, a toolkit, an old duster, a laser rifle, an EMP grenade, a half-empty canteen, and a flashlight.",playerJournalStyle:"digital"},{name:"Time Traveler's Paradox",systemInstructionModifier:"You possess a faulty experimental time-travel device. Each jump is unpredictable and risks creating dangerous paradoxes. Focus on navigating different historical eras, repairing your device, and avoiding (or fixing) alterations to the timeline.",initialMainQuest:"Stabilize your time-travel device and return to your own time period without irrevocably damaging history.",initialCurrentObjective:"Find a 19th-century physicist who might understand the temporal displacement technology.",initialSceneDescriptionSeed:"A bone-jarring lurch and a flash of disorienting colors, and you find yourself stumbling out of your shimmering temporal field onto cobblestone streets. Horse-drawn carriages clatter by. Your chronometer display is a mess of static, but the gas lamps and clothing suggest late 19th century London. Your device is sparking ominously.",initialItems:"historical disguise kit, your malfunctioning Chronometer, a pocket watch stuck on 3:07, and a mostly empty notebook.",playerJournalStyle:"typed"},{name:"Kaiju Defense Force",systemInstructionModifier:"Giant monsters (Kaiju) are emerging from the depths of the Pacific, threatening to destroy coastal cities. You are a pilot of a giant mech or a member of an elite Kaiju defense unit. Focus on strategic combat against colossal beasts, protecting civilian populations, and researching Kaiju weaknesses.",initialMainQuest:"Defeat the Alpha Kaiju 'Gorgonus' and discover the source of the Kaiju emergences.",initialCurrentObjective:"Pilot your mech 'Titan Sentinel' to intercept a Category 3 Kaiju attacking Neo-Tokyo harbor.",initialSceneDescriptionSeed:"Klaxons blare across the underground hangar. 'Category 3 Kaiju, codename 'Crustaceor,' making landfall at Neo-Tokyo Bay!' Your comm crackles. Strapping into your massive Jaeger, 'Titan Sentinel,' you feel the familiar thrum of its nuclear core. Another city to save, another monster to fight.",initialItems:"'Titan Sentinel', a standard KDF pilot suit, a datapad with Kaiju alert protocols, and an energy bar.",playerJournalStyle:"digital"},{name:"Steampunk Sky-Pirate Saga",systemInstructionModifier:"A world of floating islands, magnificent airships, and clockwork marvels. You are a daring sky-pirate (or someone caught up in their world). Focus on aerial combat, daring raids, political intrigue between sky-kingdoms, and wondrous inventions.",initialMainQuest:"Become the most notorious sky-captain by plundering the Imperial Treasury airship 'The Sovereign'.",initialCurrentObjective:"Secure enough Lumin-ether crystals to fuel your airship for the journey to the Imperial trade routes.",initialSceneDescriptionSeed:"The familiar scent of oil and ozone fills your nostrils in the cramped cockpit of your airship, 'The Comet'. Below, the cloud sea churns, hiding both treasure and peril. Your first mate reports a rival pirate vessel on an intercept course.",initialItems:"'The Comet' airship, a trusty cutlass, a pair of brass goggles, a coil of rope, and a partial sky-chart.",playerJournalStyle:"typed"}],Nt=[{name:"Eldritch Mystery Investigation",systemInstructionModifier:"The setting is a Lovecraftian fog-shrouded, 1920s coastal town plagued by unsettling occurrences and whispers of cosmic horrors. Focus on investigation, sanity checks, and deciphering cryptic clues. Items might include strange artifacts, forbidden tomes, and period-appropriate tools.",initialMainQuest:"Uncover the dark secret behind the disappearances in Innsport and stop the impending ritual.",initialCurrentObjective:"Investigate the old, decrepit lighthouse for clues about the strange lights seen at sea.",initialSceneDescriptionSeed:"A chilling gust of salty wind whips your trench coat as you step off the sputtering ferry onto Innsport's decaying docks. The town is eerily quiet, its gabled windows like vacant eyes staring out at the turbulent grey sea. A sense of profound unease settles upon you.",initialItems:"a detective's notepad and pencil, a box of matches, and a train ticket to Innsport.",playerJournalStyle:"typed"},{name:"Haunted Victorian Mansion",systemInstructionModifier:"A sprawling, decaying Victorian mansion filled with sorrowful spirits, dark family secrets, and psychological horror. Focus on puzzle-solving, uncovering the mansion's history, and surviving spectral encounters.",initialMainQuest:"Unravel the tragedy of Blackwood Manor and bring peace to its restless spirit.",initialCurrentObjective:"Find a way into the locked East Wing where the disturbances are strongest.",initialSceneDescriptionSeed:"Thunder rumbles as you push open the creaking, ornate gates of Blackwood Manor. The house looms before you, a gothic silhouette against a stormy sky. An unnerving chill crawls up your spine despite the humid night air.",initialItems:"an oil lantern, a heavy iron key of unknown purpose, and a locket containing a faded photograph.",playerJournalStyle:"handwritten"},{name:"Zombie Apocalypse Survivor",systemInstructionModifier:"The dead walk, and civilization has crumbled. You are a survivor, constantly on the move. Focus on scavenging for scarce resources (food, water, ammo), avoiding or fighting hordes of zombies, finding safe havens, and making difficult moral choices.",initialMainQuest:"Reach the rumored military-protected safe zone on Catalina Island.",initialCurrentObjective:"Find antibiotics in a deserted pharmacy for an infected member of your small group.",initialSceneDescriptionSeed:"The silence of the abandoned highway is broken only by the distant moans of the undead and the crunch of your boots on broken glass. Your friend, Sarah, is feverish; a walker got too close. The old pharmacy in the next town is your only hope for antibiotics, but it's likely overrun.",initialItems:"a sturdy baseball bat, a tattered backpack, a bottle of water, first-aid kit (low supplies), and a can of beans.",playerJournalStyle:"handwritten"},{name:"Noir Detective's Case",systemInstructionModifier:"It's the 1940s Detroit, rain-slicked streets, a city full of shadows and secrets. You're a private investigator. Focus on gathering clues, interrogating suspects, navigating moral ambiguity, and solving a complex mystery. Expect femme fatales, smoky bars, and hidden conspiracies.",initialMainQuest:"Solve the murder of socialite Eleanor Vance and expose the corruption behind it.",initialCurrentObjective:"Visit the crime scene at the Azure Club for initial clues.",initialSceneDescriptionSeed:"The city coughs up another rainy night. Your office, a cramped space above a noisy diner, smells of stale coffee and desperation. A dame with eyes like ice and a story full of holes just left, leaving behind a retainer and the name of her murdered sister: Eleanor Vance. The Azure Club is where she was last seen.",initialItems:"a worn fedora, a nearly empty pack of cigarettes, a cheap .38 revolver (6 bullets left), and a dog-eared notepad.",playerJournalStyle:"typed"}],kt=[{name:"Post-Apocalyptic Survival",systemInstructionModifier:"The world is a desolate wasteland after a interdimentional cataclysm. Resources are scarce, dangers are everywhere (mutants, raiders, anomalies, environmental hazards). Focus on scavenging, research, crafting, and making tough choices for survival.",initialMainQuest:"Find the rumored sanctuary 'Oasis' in the barren wastes.",initialCurrentObjective:"Scavenge the nearby ruined gas station for supplies.",initialSceneDescriptionSeed:"Dust stings your eyes as you crest a dune of ash and shattered concrete. The skeletal remains of a city claw at the bruised sky. Your throat is parched, and your Geiger counter clicks ominously.",initialItems:"a rusty pipe wrench, a dust mask, a bottle of water, first-aid kit, toolkit, a Geiger counter.",playerJournalStyle:"handwritten"},{name:"Wild West Outlaw",systemInstructionModifier:"The rugged, lawless frontier of the American Wild West. You're an outlaw, a bounty hunter, or a homesteader trying to survive. Focus on gunfights, train robberies, saloon brawls, and the harsh beauty of the frontier.",initialMainQuest:"Evade Marshal Blackwood and reach the 'Broken Spoke' Saloon in Redemption Gulch, a known outlaw haven.",initialCurrentObjective:"Find a fresh horse after yours went lame.",initialSceneDescriptionSeed:"The relentless sun hammers your wide-brimmed hat as you ride through the arid canyon. Dust devils dance in the distance. Your water canteen is perilously low, and the poster bearing your face is probably plastered in every town by now.",initialItems:"a Colt Peacemaker (with 5 bullets), a hunting knife, a worn bandana, and a wanted poster featuring your own face.",playerJournalStyle:"handwritten"},{name:"Age of Sail: Pirate's Fortune",systemInstructionModifier:"The turquoise waters of the Caribbean, 17th century. You are a daring pirate captain, or a new recruit on a pirate ship. Focus on ship battles, treasure hunting, evading naval patrols, and living by the pirate code.",initialMainQuest:"Find the legendary treasure of Captain One-Eye, hidden on Isla Perdida.",initialCurrentObjective:"Capture a merchant ship to resupply your vessel, 'The Sea Serpent'.",initialSceneDescriptionSeed:"The sun beats down on the deck of 'The Sea Serpent' as it slices through the waves. Your lookout spots a fat merchantman on the horizon, low in the water and ripe for the picking. The crew grins, eager for plunder. 'Hoist the colors!' you command.",initialItems:"'The Sea Serpent', a tricorne, a cutlass, a flintlock pistol, a spyglass, and a single gold doubloon.",playerJournalStyle:"handwritten"},{name:"Mad Max Road Warrior",systemInstructionModifier:"The world ended in fire and thirst. Now, desert gangs rule the highways, and gasoline is life. You are a lone road warrior in a suped-up vehicle. Focus on vehicular combat, scavenging for fuel and water, forming uneasy alliances, and surviving the brutal wasteland.",initialMainQuest:"Reach 'Gastown', the only reliable source of water and fuel, and trade for vital supplies.",initialCurrentObjective:"Escape the Buzzard gang and find a water source.",initialSceneDescriptionSeed:"The twin suns bake the cracked earth. Your V8 engine roars defiance at the silence of the wasteland. In the distance, a plume of dust signals the approach of the Buzzard gang, infamous for their cruelty and their rigged death-races. You need that water, and they're blocking the only known path.",initialItems:"your trusty vehicle 'The Interceptor', a sawed-off shotgun, jury-rigged armor, a tire iron, thick leather jacket, almost empty steel jerry can of fuel, empty plastic jerrycan for water.",playerJournalStyle:"handwritten"},{name:"Superhero Genesis",systemInstructionModifier:"A freak accident has granted you incredible powers. You're still learning to control them. Focus on discovering the extent of your abilities, deciding whether to be a hero or something else, and facing your first true nemesis.",initialMainQuest:"Master your powers and stop the supervillain 'Doctor Mayhem' from enacting his destructive plan.",initialCurrentObjective:"Stop a bank robbery being committed by thugs with unusually advanced weaponry (possibly supplied by Doctor Mayhem).",initialSceneDescriptionSeed:"Sparks involuntarily crackle from your fingertips again. Ever since the meteor shower, strange things have been happening. Last night, you accidentally flew. Today, you hear on the police scanner about a bank robbery downtown by criminals using energy weapons you've never seen before. Maybe it's time to see what you can really do.",initialItems:"a simple cloth mask, a makeshift costume, news clippings about strange events (caused by you or others), and notes on your nascent superpowers.",playerJournalStyle:"typed"}],St=[{name:"Test-Theme for many locations",systemInstructionModifier:"The world of modern fantasy in the United Kingdom. It is intended for testing locations. Create many Map Nodes of all types and statuses, and connected with edges.",initialMainQuest:"Move from place to place until the test is complete.",initialCurrentObjective:"Move somewhere",initialSceneDescriptionSeed:"You are in London, a bustling city filled with magic and mystery. The streets are alive with the sounds of people, vehicles, and the occasional magical creature. Your task is to explore various locations, interact with NPCs, and uncover secrets.",initialItems:"a magical compass that points to the nearest interesting location, a notebook for recording your findings, and a charm that protects you from minor magical mishaps.",playerJournalStyle:"typed"},{name:"Sci-Fi Future Test Theme for junk items",systemInstructionModifier:"The setting is a futuristic city filled with advanced technology and junk. It is intended for testing junk items. Create many Map Nodes of all types and statuses, and connected with edges.",initialMainQuest:"Collect junk items from various locations in the futuristic city.",initialCurrentObjective:"Find a junkyard to start collecting items.",initialSceneDescriptionSeed:"You find yourself in a sprawling futuristic city, where towering skyscrapers touch the clouds and neon lights flicker in the night. The streets are filled with people, robots, and flying vehicles. Your task is to explore the city, gather junk items, and discover their potential uses.",initialItems:"Pickup truck, a malfunctioning robot, a pile of circuit boards, and a toolset.",playerJournalStyle:"digital"},{name:"Secluded Library of Forgotten Pages",systemInstructionModifier:"The setting is a vast, labyrinthine library hidden from the world, filled with endless shelves, scattered single-page notes, cryptic manuscripts, annotated scrolls, and mysterious tomes. The air is thick with the scent of old paper and ink. Focus on discovery, deciphering clues, and piecing together fragmented knowledge from countless written materials. Expect to find loose pages tucked into books, marginalia, coded messages, and forgotten field journals. Strange phenomena may occur when certain texts are read aloud.",initialMainQuest:"Uncover the secret purpose of the Secluded Library and the identity of its original curator.",initialCurrentObjective:"Examine the scattered notes and books in the reading alcove for your first clue.",initialSceneDescriptionSeed:"You stand in a candlelit alcove surrounded by towering shelves. Books and single-page notes are strewn across tables and the floor. A faint rustling suggests the presence of something—or someone—moving among the stacks. The only exit is blocked by a pile of ancient tomes.",initialItems:"a cryptic handwritten note ('The answer is in the margins.'), a battered field journal with pressed flowers, a slim reading tablet flickering with half-erased texts, and a heavy leather-bound book titled 'The Index of Lost Beginnings.', a crude map of the Library, and a picture of a cat.",playerJournalStyle:"printed"}],H={"Fantasy & Myth":vt,"Science Fiction & Future":bt,"Horror & Dark Mystery":Nt,"Action & Wasteland":kt,Testing:St},jn=Object.keys(H),On=e=>{if(e.length===0)return[];let t=[];return e.forEach(i=>{t=t.concat(H[i])}),t},ge=(e,t)=>{const i={...e};return t.type!==void 0&&(i.type=t.type),t.description!==void 0&&(i.description=t.description),t.activeDescription!==void 0&&(i.activeDescription=t.activeDescription??void 0),t.isActive!==void 0&&(i.isActive=t.isActive),t.tags!==void 0&&(i.tags=t.tags),t.chapters!==void 0&&(i.chapters=t.chapters),t.knownUses!==void 0&&(i.knownUses=t.knownUses),t.holderId!==void 0&&t.holderId.trim()!==""&&(i.holderId=t.holderId),i},Mt=(e,t)=>{let i=[...e];switch(t.action){case"create":{const a=t.item,o=i.findIndex(n=>n.id===a.id);o!==-1?i[o]=a:i.push(a);break}case"destroy":{const a=t.item,o=D([a.id,a.name],i,!1,!0),n=Array.isArray(o)?null:o;n&&(i=i.filter(r=>r.id!==n.id));break}case"move":{const a=t.item,o=D([a.id,a.name],i,!1,!0),n=Array.isArray(o)?null:o;if(n){const r=i.findIndex(s=>s.id===n.id);i[r]={...n,holderId:a.newHolderId}}break}case"change":{const a=t.item,o=D([a.id,a.name],i,!1,!0),n=Array.isArray(o)?null:o;if(n){const r=i.findIndex(l=>l.id===n.id),s=a.newName===void 0&&a.name!==void 0&&a.name!==n.name,c=a.newName??(s?a.name:void 0),d=ge(n,a);c&&c.trim()!==""&&c!==n.name&&(d.name=c),i[r]=d}break}case"addDetails":{const a=t.item,o=D([a.id,a.name],i,!1,!0),n=Array.isArray(o)?null:o;if(n){const r=i.findIndex(c=>c.id===n.id),s={...n};if(a.chapters&&a.chapters.length>0&&(s.chapters=[...n.chapters??[],...a.chapters]),a.tags&&a.tags.length>0){const c=new Set(n.tags??[]);for(const d of a.tags)c.add(d);s.tags=Array.from(c)}if(a.knownUses&&a.knownUses.length>0){const c=[...n.knownUses??[]];for(const d of a.knownUses){const l=c.findIndex(m=>m.actionName===d.actionName);l!==-1?c[l]=d:c.push(d)}s.knownUses=c}s.lastInspectTurn=void 0,i[r]=s}break}}return i},Pn=(e,t)=>{const i=[];for(const a of e){let o=null;if(a.action==="create"){const n=a.item;n.id||(n.id=It(n.name)),o={type:"acquire",acquiredItem:{...n,activeDescription:n.activeDescription??void 0,isActive:n.isActive??!1,knownUses:n.knownUses??[],tags:n.tags??[]}}}else if(a.action==="destroy"){const n=a.item,r=D([n.id,n.name],t,!1,!0),s=Array.isArray(r)?null:r;s&&(o={type:"loss",lostItem:{...s}})}else if(a.action==="move"){const n=a.item,r=D([n.id,n.name],t,!1,!0),s=Array.isArray(r)?null:r;if(s){const c={...s},d={...s,holderId:n.newHolderId};o={type:"update",oldItem:c,newItem:d}}}else if(a.action==="change"){const n=a.item,r=D([n.id,n.name],t,!1,!0),s=Array.isArray(r)?null:r;if(s){const c={...s},d=n.newName===void 0&&n.name!==void 0&&n.name!==s.name,l=n.newName??(d?n.name:void 0),m=ge(s,n);l&&l.trim()!==""&&l!==s.name&&(m.name=l),o={type:"update",oldItem:c,newItem:m}}}else{const n=a.item,r=D([n.id,n.name],t,!1,!0),s=Array.isArray(r)?null:r;if(s){const c={...s};let d={...s};if(n.chapters&&n.chapters.length>0&&(d={...d,chapters:[...s.chapters??[],...n.chapters]}),n.tags&&n.tags.length>0){const l=new Set(s.tags??[]);for(const m of n.tags)l.add(m);d.tags=Array.from(l)}if(n.knownUses&&n.knownUses.length>0){const l=[...s.knownUses??[]];for(const m of n.knownUses){const g=l.findIndex(f=>f.actionName===m.actionName);g!==-1?l[g]=m:l.push(m)}d.knownUses=l}o={type:"update",oldItem:c,newItem:d}}}o&&i.push(o)}return i},Rn=(e,t)=>{let i=[...t];for(const a of e)i=Mt(i,a);return i},Tt=(e,t,i,a)=>{const o=[];return e.forEach(n=>{const r={...n,id:me(n.name),themeName:i,aliases:n.aliases??[],presenceStatus:n.presenceStatus??"unknown",lastKnownLocation:n.lastKnownLocation??null,preciseLocation:n.preciseLocation??null,dialogueSummaries:[]};o.push({type:"add",npcName:r.name,addedNPC:r})}),t.forEach(n=>{const r=a.find(s=>s.name===n.name&&s.themeName===i);if(r){const s={...r,dialogueSummaries:r.dialogueSummaries??[]};n.newDescription!==void 0&&(s.description=n.newDescription),n.newAliases!==void 0&&(s.aliases=n.newAliases),n.addAlias&&(s.aliases=Array.from(new Set([...s.aliases??[],n.addAlias]))),n.newPresenceStatus!==void 0&&(s.presenceStatus=n.newPresenceStatus),n.newLastKnownLocation!==void 0&&(s.lastKnownLocation=n.newLastKnownLocation),n.newPreciseLocation!==void 0&&(s.preciseLocation=n.newPreciseLocation),s.presenceStatus==="distant"||s.presenceStatus==="unknown"?s.preciseLocation=null:s.preciseLocation??(s.preciseLocation=s.presenceStatus==="companion"?"with you":"nearby in the scene"),o.push({type:"update",npcName:n.name,oldNPC:{...r},newNPC:s})}}),o},Et=(e,t,i,a)=>{const o=[...a];return e.forEach(n=>{if(!o.some(r=>r.name===n.name&&r.themeName===i)){const r={...n,id:me(n.name),themeName:i,aliases:n.aliases??[],presenceStatus:n.presenceStatus??"unknown",lastKnownLocation:n.lastKnownLocation??null,preciseLocation:n.preciseLocation??null,dialogueSummaries:[]};(r.presenceStatus==="distant"||r.presenceStatus==="unknown")&&(r.preciseLocation=null),o.push(r)}}),t.forEach(n=>{const r=o.findIndex(s=>s.name===n.name&&s.themeName===i);if(r!==-1){const s={...o[r],dialogueSummaries:o[r].dialogueSummaries??[]};n.newDescription!==void 0&&(s.description=n.newDescription),n.newAliases!==void 0&&(s.aliases=n.newAliases),n.addAlias&&(s.aliases=Array.from(new Set([...s.aliases??[],n.addAlias]))),n.newPresenceStatus!==void 0&&(s.presenceStatus=n.newPresenceStatus),n.newLastKnownLocation!==void 0&&(s.lastKnownLocation=n.newLastKnownLocation),n.newPreciseLocation!==void 0&&(s.preciseLocation=n.newPreciseLocation),s.presenceStatus==="distant"||s.presenceStatus==="unknown"?s.preciseLocation=null:s.preciseLocation??(s.preciseLocation=s.presenceStatus==="companion"?"with you":"nearby in the scene"),o[r]=s}}),o},Fn=(e,t,i)=>{const a=[...e,t];return a.length>i?a.slice(a.length-i):a},Yn=(e,t)=>{const i=`You left your ${t}`;for(let a=e.length-1;a>=0;a-=1)if(e[a].startsWith(i))return[...e.slice(0,a),...e.slice(a+1)];return e},Wn=(e,t)=>{if(e.length===0)return null;const i=t&&e.length>1?e.filter(n=>n.name!==t):e,a=i.length>0?i:e,o=Math.floor(Math.random()*a.length);return a[o].name},Hn=(e,t,i,a)=>{let o=e.themeFacts.length>0?Math.max(...e.themeFacts.map(n=>n.id))+1:1;for(const n of t)switch(n.action){case"add":if(n.fact&&n.fact.text&&a){const r={id:o++,text:n.fact.text,entities:n.fact.entities??[],themeName:a,createdTurn:n.fact.createdTurn??i,tier:n.fact.tier??1};e.themeFacts.push(r)}break;case"change":{const r=e.themeFacts.findIndex(s=>s.id===n.id);if(r>=0&&n.fact){const s={...e.themeFacts[r],...n.fact,themeName:e.themeFacts[r].themeName};e.themeFacts[r]=s}break}case"delete":{const r=e.themeFacts.findIndex(s=>s.id===n.id);r>=0&&e.themeFacts.splice(r,1);break}}},At=(e,t)=>{e.length===0||Object.keys(t).length===0||e.forEach(i=>{i.entities=i.entities.map(a=>t[a]??a)})},xt=(e,t)=>{const i=document.querySelector(".highlight-tooltip");i&&i.remove();const a=document.createElement("div");a.className="highlight-tooltip",a.textContent=e,document.body.appendChild(a);const o=8,n=t.left+t.width/2-a.offsetWidth/2+window.scrollX,r=t.bottom+o+window.scrollY;a.style.left=`${String(Math.max(4,Math.min(n,window.innerWidth-a.offsetWidth-4)))}px`,a.style.top=`${String(r)}px`;const s=()=>{a.remove(),document.removeEventListener("click",c)},c=d=>{a.contains(d.target)||s()};setTimeout(()=>{document.addEventListener("click",c)},0)};let Y=null;const Ct=e=>{const t=JSON.stringify(e.map(r=>({name:r.name,aliases:r.aliases??[],type:r.type})).sort((r,s)=>r.name.localeCompare(s.name)));if(Y&&Y.key===t)return Y.value;const i=new Map;e.forEach(r=>{const s=(d,l)=>{if(d&&d.trim()!==""){const m=d.toLowerCase();i.has(m)||i.set(m,{term:l,entityData:r})}};s(r.name,r.name),(r.aliases??[]).forEach(d=>{s(d,d)});const c=r.name.toLowerCase();if(c.startsWith("the ")&&r.name.length>4){const d=r.name.substring(4);s(d,d)}else if(c.startsWith("a ")&&r.name.length>2){const d=r.name.substring(2);s(d,d)}});const a=Array.from(i.values());if(a.sort((r,s)=>s.term.length-r.term.length),a.length===0)return null;const o=a.map(r=>r.term.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")).filter(r=>r.length>0).join("|");if(!o)return null;const n={regex:new RegExp(`\\b(${o})\\b`,"gi"),lookup:new Map(a.map(r=>[r.term.toLowerCase(),r]))};return Y={key:t,value:n},n},$t=e=>{switch(e){case"item":return"font-semibold text-amber-400 hover:text-amber-300 cursor-pointer";case"place":return"font-semibold text-violet-400 hover:text-violet-300 cursor-pointer";case"npc":return"font-semibold text-green-300 hover:text-green-200 cursor-pointer";default:return""}},Un=(e,t,i=!1)=>{if(!e)return[e??""];const a=Ct(t);if(!a)return[e];const{regex:o,lookup:n}=a,r=[];let s=0,c;for(;(c=o.exec(e))!==null;){const d=c[0],l=n.get(d.toLowerCase());if(c.index>s&&r.push(e.substring(s,c.index)),l){const m=g=>{if(window.matchMedia("(hover: none)").matches){const f=g.currentTarget.getBoundingClientRect(),h=g.currentTarget.getAttribute("title")??"";xt(h,f)}};r.push(x.jsx("span",{className:$t(l.entityData.type),onClick:i?m:void 0,title:l.entityData.description,children:d},`${l.entityData.name}-${l.term}-${String(c.index)}`))}else r.push(d);s=o.lastIndex}return s<e.length&&r.push(e.substring(s)),r.length>0?r:[e]},Gn=(e,t,i,a)=>{const o=e.map(s=>({name:s.name,type:"item",description:s.isActive&&s.activeDescription?s.activeDescription:s.description,item:s})),n=a?t.filter(s=>s.themeName===a).map(s=>({name:s.placeName,type:"place",description:s.data.description,aliases:s.data.aliases??[]})):[],r=a?i.filter(s=>s.themeName===a).map(s=>({name:s.name,type:"npc",description:s.description,aliases:s.aliases})):[];return[...o,...n,...r]};new Set(at);new Set(it);const Dt=(e,t)=>{const i=[];let a=t.get(e.data.parentNodeId??"");for(;a&&(i.push(a),!(!a.data.parentNodeId||a.data.parentNodeId==="Universe"));)a=t.get(a.data.parentNodeId);return i},Z=(e,t,i)=>{let a=e;for(;a!=null&&a.data.parentNodeId&&a.data.parentNodeId!=="Universe";){if(a.data.parentNodeId===t.id)return!0;a=i.get(a.data.parentNodeId)}return!1},Bn=(e,t,i)=>{const a=new Map(e.nodes.map(r=>[r.id,r])),o=a.get(t),n=a.get(i);return!o||!n?!1:Z(o,n,a)},Kn=(e,t)=>{const{adjacency:i}=X(e),a=new Map(e.edges.map(n=>[n.id,n])),o=["open","accessible","active"];return(i.get(t)??[]).filter(n=>{const r=a.get(n.edgeId);if(!r)return!0;const s=r.data.status??"open";return o.includes(s)}).map(n=>n.to)},Lt=e=>{const t=new Map,i=a=>a!=="rumored"&&a!=="removed";for(const a of e.edges){if(!i(a.data.status))continue;t.has(a.sourceNodeId)||t.set(a.sourceNodeId,[]);const o=t.get(a.sourceNodeId)??[];o.push({nodeId:a.targetNodeId,edgeId:a.id}),t.set(a.sourceNodeId,o),t.has(a.targetNodeId)||t.set(a.targetNodeId,[]);const n=t.get(a.targetNodeId)??[];n.push({nodeId:a.sourceNodeId,edgeId:a.id}),t.set(a.targetNodeId,n)}return t},_t=(e,t,i,a)=>{const o=new Set,n=[];for(o.add(t),n.push(t);n.length>0;){const r=n.shift();if(!r)continue;if(r===i)return!0;const s=e.get(r)??[];for(const{nodeId:c,edgeId:d}of s)d!==a&&(o.has(c)||(o.add(c),n.push(c)))}return!1},jt=(e,t,i="New Approach")=>{const a=G(e),o=a.nodes.findIndex(l=>l.id===t);if(o===-1)return{updatedMapData:a,newNode:null,newEdges:[]};const n=a.nodes[o];if(n.data.nodeType!=="feature")return{updatedMapData:a,newNode:null,newEdges:[]};n.data.nodeType="region";const r=P(`node_${i}_`),s={id:r,themeName:n.themeName,placeName:i,position:{...n.position},data:{description:n.data.description,aliases:n.data.aliases??[],status:n.data.status,nodeType:"feature",parentNodeId:n.id,visited:n.data.visited}};a.nodes.push(s),a.edges.forEach(l=>{l.sourceNodeId===t&&(l.sourceNodeId=r),l.targetNodeId===t&&(l.targetNodeId=r)});const c=a.nodes.filter(l=>l.data.parentNodeId===t&&l.id!==r),d=[];return c.forEach(l=>{const g={id:P(`edge_${r}_to_${l.id}`),sourceNodeId:r,targetNodeId:l.id,data:{type:"path",status:n.data.status==="rumored"?"rumored":"open",description:`Connection from ${i} to ${l.placeName}`}};a.edges.push(g),d.push(g)}),{updatedMapData:a,newNode:s,newEdges:d}},Ot=async(e,t)=>{let i=G(e);const a=[],o=[];for(const n of i.nodes)if(n.data.nodeType==="feature"){const r=i.nodes.filter(s=>s.data.parentNodeId===n.id);if(r.length>0)if(await Le(n,r[0])==="convert_child")r.forEach(c=>{c.data.parentNodeId=n.data.parentNodeId});else{const c=jt(i,n.id,"Temp Approach");i=c.updatedMapData,c.newNode&&a.push(c.newNode),o.push(...c.newEdges)}}return{updatedMapData:i,addedNodes:a,addedEdges:o}},Jn=async(e,t)=>{try{return(await Ot(e,t)).updatedMapData}catch(i){return console.error("repairFeatureHierarchy error:",i),e}},Pt=async(e,t,i,a,o,n,r)=>(console.error("API Key not configured for Map Update Service."),null),Rt=[{keywords:["inside of","inside"],type:"direct",weight:100},{keywords:["atop of","atop"],type:"direct",weight:100},{keywords:["at the center of","at the heart of","at the"],type:"direct",weight:90},{keywords:["at"],type:"direct",weight:85},{keywords:["within"],type:"direct",weight:95},{keywords:["on top of","on"],type:"direct",weight:90},{keywords:["entering into","entering"],type:"direct",weight:90},{keywords:["overlooking"],type:"relational",weight:60},{keywords:["leading to","leading towards"],type:"relational",weight:55},{keywords:["near to","near by","nearby","near","close to","by","beside","next to"],type:"relational",weight:50},{keywords:["facing"],type:"relational",weight:45},{keywords:["approaching"],type:"relational",weight:40},{keywords:["exiting from","exiting","leaving from","leaving"],type:"relational",weight:35},{keywords:["heading to","heading towards","going to","going towards"],type:"relational",weight:50},{keywords:["coming from","arriving from"],type:"relational",weight:30},{keywords:["outside of","outside","behind"],type:"negating",weight:30},{keywords:["away from","far from"],type:"negating",weight:20},{keywords:["beyond"],type:"negating",weight:25},{keywords:["of the","of a","of an","of"],type:"contextual_linking",weight:5},{keywords:["from the","from a","from an","from"],type:"contextual_linking",weight:5}],ye=[...Rt].sort((e,t)=>Math.max(...t.keywords.map(i=>i.length))-Math.max(...e.keywords.map(i=>i.length))),Ft=ye.filter(e=>e.type!=="contextual_linking").flatMap(e=>e.keywords).sort((e,t)=>t.length-e.length),Yt=new Set(["the","a","an","is","are","was","were","am","i","you","he","she","it","we","they","and","or","but","so","then","just","very","quite","also","too","now","player","character","up","down","left","right","north","south","east","west","above","below","under","over","through","around","along","across","between","among","front","go","look","see","find","take","get","move","walk","run","stand","sit","player is","several","stories"]),$=e=>e?e.toLowerCase().replace(/[.,!?;:"(){}[\]'’]/g,"").trim():"",Wt=e=>e?$(e).split(/\s+/).map(i=>i.replace(/^['"]+|['"]+$/g,"")).filter(i=>i.length>0&&!Yt.has(i)).map(i=>i.trim()).filter(i=>i.length>0):[];function Ht(e,t){if(!e||!t||e===t||e.length<3&&t.length<3)return!1;const i=e.toLowerCase(),a=t.toLowerCase();return!!(i===a+"s"||a===i+"s"||i.endsWith("es")&&i.slice(0,-2)===a||a.endsWith("es")&&a.slice(0,-2)===i||i.endsWith("ies")&&i.slice(0,-3)+"y"===a||a.endsWith("ies")&&a.slice(0,-3)+"y"===i)}const Ut=e=>{if(!e||e.trim()==="")return[];const t=[],i=`\\b(?:${Ft.map(l=>l.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")).join("|")})\\b`,a=new RegExp(i,"gi"),o=[];let n;for(;(n=a.exec(e))!==null;){const l=n[0].toLowerCase(),m=ye.find(g=>g.keywords.includes(l));m&&m.type!=="contextual_linking"&&o.push({index:n.index,text:l,originalText:n[0],definition:m})}o.sort((l,m)=>l.index-m.index);let r=0;const s=o.length>0?o[0].index:e.length;let c=e.substring(0,s).trim();const d=c.indexOf(",");d!==-1&&(c=c.substring(0,d).trim()),c&&t.push({phrase:c,prepositionKeyword:"implicit_subject",prepositionType:"direct",prepositionWeight:100});for(let l=0;l<o.length;l++){const m=o[l];r=m.index+m.originalText.length;const g=l+1<o.length?o[l+1].index:e.length;let f=e.substring(r,g).trim();const h=f.indexOf(",");h!==-1&&(f=f.substring(0,h).trim()),f&&t.push({phrase:f,prepositionKeyword:m.text,prepositionType:m.definition.type,prepositionWeight:m.definition.weight,originalPrepositionText:m.originalText})}return t.filter(l=>l.phrase.length>0)},Gt=30,Bt=10,U=Wt,Kt=(e,t,i)=>{const a=[];for(const o of i){const n=[o.placeName,...o.data.aliases??[]];for(const r of n.filter(s=>s&&s.trim()!=="")){const s=$(r),c=U(r).join(" ");let d=0;if(s===e?d=1e3:e.endsWith(s)&&e.length>s.length?d=950:e.startsWith(s)&&e.length>s.length?d=920:c&&t&&c===t?d=900:e.includes(s)&&s.length>0&&(d=800+s.length*.5),d>0){const l=o.data.nodeType==="feature";a.push({nodeId:o.id,score:d+(l?Bt:0),isFeature:l,nameLength:r.length})}}}return a},Jt=(e,t,i)=>{const{node:a,nameTokenPairs:o}=e;let n=-1;for(const{name:r,tokens:s}of o){if(s.length===0)continue;let c=0;for(const d of t){const l=U(d.phrase);if(l.length===0)continue;let m=0;const g=[...l];if(s.forEach(f=>{const h=g.indexOf(f);if(h!==-1)m++,g.splice(h,1);else{const u=g.findIndex(p=>Ht(f,p));u!==-1&&(m++,g.splice(u,1))}}),m>0){const f=m/s.length,h=m/l.length;let u=f*60+h*40;const p=$(r),y=$(d.phrase);let w=0;p===y?w=100:y.endsWith(p)&&y.length>p.length?w=75:y.startsWith(p)&&y.length>p.length?w=70:y.includes(p)?w=50+p.length*.2:p.includes(y)&&(w=25+y.length*.2),u+=w;const N=d.prepositionType==="negating"&&u>75?d.prepositionWeight*.5:d.prepositionWeight;c+=u*(N/100)}}c>n&&(n=c)}return n>-1&&i.has(a.id)&&(n+=Gt),n},zt=(e,t,i)=>{if(!e||t.score>e.score)return t;if(t.score<e.score)return e;const a=i.find(d=>d.id===t.nodeId),o=i.find(d=>d.id===e.nodeId);if(!a||!o)return e;const n=a.data.nodeType==="feature",r=o.data.nodeType==="feature";if(n&&!r)return t;if(!n&&r)return e;const s=$(a.placeName).length,c=$(o.placeName).length;return s>c?t:e},Vt=(e,t,i)=>{if(!e)return null;const a=i.find(n=>n.id===e);if(!a||a.data.nodeType==="feature"||a.data.parentNodeId&&a.data.parentNodeId!=="Universe")return e;const o=i.filter(n=>n.data.nodeType==="feature"&&n.data.parentNodeId===a.id);for(const n of o){const r=n.placeName,s=$(r);if(t.find(d=>d.prepositionType==="direct"&&$(d.phrase).includes(s)))return n.id}return e},ae=(e,t,i,a,o)=>{if(!e||e.trim()==="")return console.log(`MapNodeMatcher (${t}): No suggestion provided or suggestion is empty.`),{matched:!1,nodeId:null};if(o.length===0)return console.log(`MapNodeMatcher (${t}): No nodes found for theme "${a}" in draft state.`),{matched:!1,nodeId:null};const n=o.find(h=>h.id===e);if(n)return console.log(`MapNodeMatcher (${t}): AI suggested node ID "${e}", matched to ID "${n.id}".`),{matched:!0,nodeId:n.id};const r=e.toLowerCase();let s=o.find(h=>h.id.toLowerCase().includes(r));const c=/^(.*)_([a-zA-Z0-9]{4})$/;let d=null;if(!s){const h=c.exec(e);if(h){const u=h[1];d=u,s=o.find(p=>p.id.toLowerCase().includes(u.toLowerCase()))}}if(s)return console.log(`MapNodeMatcher (${t}): Heuristically matched malformed ID "${e}" to "${s.id}".`),{matched:!0,nodeId:s.id};const l=e.toLowerCase(),m=o.filter(h=>{var u;return h.placeName.toLowerCase()===l||((u=h.data.aliases)==null?void 0:u.some(p=>p.toLowerCase()===l))});if(m.length===0){const u=(d??e).replace(/_/g," ").toLowerCase();m.push(...o.filter(p=>{var y;return p.placeName.toLowerCase()===u||((y=p.data.aliases)==null?void 0:y.some(w=>w.toLowerCase()===u))}))}if(m.length===0)return console.log(`MapNodeMatcher (${t}): AI suggested identifier "${e}" NOT found by ID, name, or alias within theme "${a}".`),{matched:!1,nodeId:null};if(m.length===1){const h=m[0];return console.log(`MapNodeMatcher (${t}): AI suggested node NAME/ALIAS "${e}", uniquely matched to ID "${h.id}".`),{matched:!0,nodeId:h.id}}if(console.log(`MapNodeMatcher (${t}): AI suggested node NAME/ALIAS "${e}", multiple matches found. Applying tie-breaking.`),i){const h=m.find(u=>u.id===i);if(h)return console.log(`MapNodeMatcher (${t}): Tie-breaker: Matched oldMapNodeId "${i}".`),{matched:!0,nodeId:h.id}}const g=m.filter(h=>h.data.nodeType!=="feature");if(g.length>0){const h=g[0];return console.log(`MapNodeMatcher (${t}): Tie-breaker: Chose non-feature node "${h.placeName}" (ID: ${h.id}).`),{matched:!0,nodeId:h.id}}const f=m[0];return console.log(`MapNodeMatcher (${t}): Tie-breaker: Chose first feature node match "${f.placeName}" (ID: ${f.id}).`),{matched:!0,nodeId:f.id}},Qt=(e,t,i,a,o)=>{if(!e||!t||a.length===0)return null;const n=a,r=e.indexOf(","),s=(r!==-1?e.substring(0,r):e).trim(),c=$(s),d=U(e).join(" "),l=Kt(c,d,n);if(l.length>0)return l.sort((p,y)=>y.score!==p.score?y.score-p.score:p.isFeature!==y.isFeature?p.isFeature?-1:1:y.nameLength-p.nameLength),l[0].nodeId;const m=Ut(e);if(m.length===0)return null;let g=null;const f=new Set;o&&i.edges.forEach(p=>{p.sourceNodeId===o?f.add(p.targetNodeId):p.targetNodeId===o&&f.add(p.sourceNodeId)});const h=n.map(p=>({node:p,nameTokenPairs:[p.placeName,...p.data.aliases??[]].filter(y=>y&&y.trim()!=="").map(y=>({name:y,tokens:U(y)}))}));for(const p of h){const y=Jt(p,m,f);if(y>-1){const w={nodeId:p.node.id,score:y};g=zt(g,w,n)}}let u=g?g.nodeId:null;return g&&g.score>0&&(u=Vt(u,m,n)),u},zn=async(e,t,i,a,o,n,r)=>{var y,w,N,b,k;let s,c=null;if("mapUpdated"in e&&e.mapUpdated||t.localPlace!==i.localPlace){const I=o;n("map");const S=t.mapData.nodes.filter(v=>v.themeName===a.name&&v.data.nodeType!=="feature");if(c=await Pt(e,t.mapData,a,S,i.currentMapNodeId,t.inventory,t.allNPCs),n(I),!c)throw new Error("Map Update Service returned no data.");if(!c.updatedMapData){const v=((y=c.debugInfo)==null?void 0:y.validationError)??((w=c.debugInfo)==null?void 0:w.rawResponse)??"Unknown error";throw new Error(`Map update failed: ${v}`)}if(JSON.stringify(t.mapData)!==JSON.stringify(c.updatedMapData)&&(r.mapDataChanged=!0,t.mapData=c.updatedMapData),c.debugInfo&&t.lastDebugPacket&&(t.lastDebugPacket.mapUpdateDebugInfo=c.debugInfo),s=(b=(N=c.debugInfo)==null?void 0:N.parsedPayload)==null?void 0:b.suggestedCurrentMapNodeId,c.newlyAddedNodes.length>0){for(const v of c.newlyAddedNodes)if(v.data.nodeType!=="feature"){const T=t.mapData.nodes.find(E=>E.id===v.id);if(T&&(!T.data.description||T.data.description.trim()===""||T.data.description.startsWith("Description missing"))){const E=o;n("correction");const A=await _e(v.placeName,e.logMessage,"sceneDescription"in e?e.sceneDescription:i.currentScene);if(n(E),A){const K=t.mapData.nodes.findIndex(we=>we.id===T.id);K!==-1&&(t.mapData.nodes[K].data.description=A.description,t.mapData.nodes[K].data.aliases=A.aliases??[],r.mapDataChanged=!0)}}}}}const d=await je(t.mapData.nodes.filter(I=>I.themeName===a.name),a,(k=c==null?void 0:c.debugInfo)==null?void 0:k.minimalModelCalls);if(d.length>0){const I={};for(const S of d){const v=t.mapData.nodes.findIndex(A=>A.id===S.nodeId);if(v===-1)continue;const M=t.mapData.nodes[v],T=M.id,E=wt(S.newName);I[T]=E,M.placeName=S.newName,M.id=E,t.mapData.nodes.forEach(A=>{A.data.parentNodeId===T&&(A.data.parentNodeId=E)}),t.mapData.edges.forEach(A=>{A.sourceNodeId===T&&(A.sourceNodeId=E),A.targetNodeId===T&&(A.targetNodeId=E)}),t.inventory.forEach(A=>{A.holderId===T&&(A.holderId=E)}),t.currentMapNodeId===T&&(t.currentMapNodeId=E),t.destinationNodeId===T&&(t.destinationNodeId=E)}Object.keys(I).length>0&&At(t.themeFacts,I),r.mapDataChanged=!0}const l=new Set(((c==null?void 0:c.newlyAddedEdges)??[]).map(I=>I.id)),m=a.name,g="npcsAdded"in e&&e.npcsAdded?e.npcsAdded:[],f="npcsUpdated"in e&&e.npcsUpdated?e.npcsUpdated:[];(g.length>0||f.length>0)&&(r.npcChanges=Tt(g,f,m,t.allNPCs),t.allNPCs=Et(g,f,m,t.allNPCs));const h=i.currentMapNodeId;let u=h;const p=t.mapData.nodes.filter(I=>I.themeName===a.name);if(s){const I=ae(s,"mapAI",h,a.name,p);I.matched&&(u=I.nodeId)}if(!s&&"currentMapNodeId"in e&&e.currentMapNodeId){const I=ae(e.currentMapNodeId,"mainAI",h,a.name,p);I.matched&&(u=I.nodeId)}if(!s&&!("currentMapNodeId"in e&&e.currentMapNodeId)&&t.localPlace&&(u=Qt(t.localPlace,a,t.mapData,p,h)??h),t.currentMapNodeId=u,t.currentMapNodeId!==h&&(r.currentMapNodeIdChanged=!0),t.currentMapNodeId&&t.destinationNodeId){const I=new Map(t.mapData.nodes.map(M=>[M.id,M])),S=I.get(t.currentMapNodeId),v=I.get(t.destinationNodeId);S&&v&&(S.id===v.id||Z(S,v,I))&&(t.destinationNodeId=null)}if(t.currentMapNodeId){const I=t.mapData.nodes.findIndex(S=>S.id===t.currentMapNodeId);if(I!==-1){t.mapData.nodes[I].data.visited||(t.mapData.nodes[I].data.visited=!0,(t.mapData.nodes[I].data.status==="rumored"||t.mapData.nodes[I].data.status==="undiscovered")&&(t.mapData.nodes[I].data.status="discovered"),r.mapDataChanged=!0);const S=new Map(t.mapData.nodes.map(T=>[T.id,T])),v=t.mapData.nodes[I],M=Dt(v,S);for(const T of M){const E=t.mapData.nodes.findIndex(A=>A.id===T.id);E!==-1&&!t.mapData.nodes[E].data.visited&&(t.mapData.nodes[E].data.visited=!0,(t.mapData.nodes[E].data.status==="rumored"||t.mapData.nodes[E].data.status==="undiscovered")&&(t.mapData.nodes[E].data.status="discovered"),r.mapDataChanged=!0)}}}if(r.mapDataChanged){const I=new Set(t.mapData.nodes.filter(M=>M.data.visited).map(M=>M.id)),S=[],v=Lt(t.mapData);t.mapData.edges.forEach((M,T)=>{l.has(M.id)||I.has(M.sourceNodeId)&&I.has(M.targetNodeId)&&(M.data.status==="rumored"||M.data.status==="removed")&&(_t(v,M.sourceNodeId,M.targetNodeId,M.id)?S.push(T):(M.data.status="open",r.mapDataChanged=!0))}),S.length>0&&(t.mapData.edges=t.mapData.edges.filter((M,T)=>!S.includes(T)))}return s};function Vn(e){return e.replace(/[a-zA-Z]/g,t=>{const i=t.charCodeAt(0),a=i<=90?65:97;return String.fromCharCode((i-a+13)%26+a)})}const qt={A:"ᚨ",B:"ᛒ",C:"ᚲ",D:"ᛞ",E:"ᛖ",F:"ᚠ",G:"ᚷ",H:"ᚻ",I:"ᛁ",J:"ᛃ",K:"ᚲ",L:"ᛚ",M:"ᛗ",N:"ᚾ",O:"ᚩ",P:"ᛈ",Q:"ᚲ",R:"ᚱ",S:"ᛊ",T:"ᛏ",U:"ᚢ",V:"ᚡ",W:"ᚹ",X:"ᛉ",Y:"ᛣ",Z:"ᛉ",a:"ᚨ",b:"ᛒ",c:"ᚲ",d:"ᛞ",e:"ᛖ",f:"ᚠ",g:"ᚷ",h:"ᚻ",i:"ᛁ",j:"ᛃ",k:"ᚲ",l:"ᛚ",m:"ᛗ",n:"ᚾ",o:"ᚩ",p:"ᛈ",q:"ᚲ",r:"ᚱ",s:"ᛊ",t:"ᛏ",u:"ᚢ",v:"ᚡ",w:"ᚹ",x:"ᛉ",y:"ᛣ",z:"ᛉ"};function Qn(e){return e.split("").map(t=>qt[t]??t).join("")}function qn(e){const t=Math.floor(e.length/2),i=e.lastIndexOf(" ",t),a=e.indexOf(" ",t),o=i!==-1&&t-i<20?i:a!==-1&&a-t<20?a:t,n=Math.random()<.5,r=`
--- torn ---
`;return n?`${e.slice(0,o)}${r}`:`${r}${e.slice(o)}`}const Xn=(e,t)=>{let i=e,a=2;for(;t.some(o=>o.heading===i);)i=`${e} (${String(a)})`,a+=1;return i},Zn=e=>{if(!e)return null;for(const t in H){const a=H[t].find(o=>o.name===e);if(a)return a}return null},ea=(e,t,i)=>{const a=e.getScreenCTM();if(!a)return{x:t,y:i};const o=a.inverse(),n=e.createSVGPoint();n.x=t,n.y=i;const r=n.matrixTransform(o);return{x:r.x,y:r.y}},ta=(e,t,i)=>{const a=e.getScreenCTM();if(!a)return{x:t,y:i};const o=e.createSVGPoint();o.x=t,o.y=i;const n=o.matrixTransform(a);return{x:n.x,y:n.y}},Xt=e=>{if(e.data.visualRadius)return e.data.visualRadius;switch(e.data.nodeType){case"region":return C*2.4;case"location":return C*2;case"settlement":return C*1.8;case"district":return C*1.6;case"exterior":return C*1.4;case"interior":return C*1.2;case"room":return C*.8;case"feature":return C*.6;default:return C*.6}},Zt=(e,t,i)=>{if(!e)return[];const a=e.split(" "),o=[];let n="";for(const r of a){if(o.length===i)break;if(n.length===0)n=r;else if(n.length+r.length+1<=t)n+=` ${r}`;else{if(o.push(n),o.length===i){if(r){const s=o[i-1];s.length>3?o[i-1]=s.slice(0,-3)+"...":o[i-1]=".."}n="";break}n=r}}if(n&&o.length<i?o.push(n):n&&o.length===i&&o[i-1]&&!o[i-1].endsWith("...")&&(o[i-1].length>3?o[i-1]=o[i-1].slice(0,-3)+"...":o[i-1]=".."),o.length===i&&e.split(" ").length>a.indexOf(n.split(" ")[0])+n.split(" ").length){const r=o[i-1];r&&r.length>3&&!r.endsWith("...")?o[i-1]=r.slice(0,Math.max(0,r.length-3))+"...":r&&!r.endsWith("...")&&(o[i-1]="..")}return o},ie=e=>e==="feature"||e==="room"||e==="interior",en=e=>e==="feature",na=(e,t)=>{const i=new Map(e.map(u=>[u.id,u])),a=new Map;e.forEach(u=>{if(u.data.parentNodeId){const p=a.get(u.data.parentNodeId)??[];p.push(u),a.set(u.data.parentNodeId,p)}});const o=new Map,n=u=>{if(!u)return 0;const p=o.get(u.id);if(p!==void 0)return p;const y=u.data.parentNodeId?i.get(u.data.parentNodeId):void 0,w=y?n(y)+1:0;return o.set(u.id,w),w};e.forEach(u=>n(u));const r=u=>a.has(u.id),s=u=>ie(u.data.nodeType)?7:12,c={},d=u=>{const p=c[u.id];if(p)return p;const y=ie(u.data.nodeType)||!r(u)?20:25,w=Zt(u.placeName,y,Oe);return c[u.id]=w,w},l=u=>d(u).length*s(u)*oe,m=u=>Math.max(...d(u).map(p=>p.length*s(u)*.6)),g=(u,p)=>{const y=m(u),w=l(u);if(en(u.data.nodeType))return{x:u.position.x-y/2,y:u.position.y-w/2,width:y,height:w*2};const N=Xt(u)+se+p;return{x:u.position.x-y/2,y:u.position.y+N,width:y,height:w}},f={};e.forEach(u=>{f[u.id]=0});const h=(u,p)=>u.x<p.x+p.width&&u.x+u.width>p.x&&u.y<p.y+p.height&&u.y+u.height>p.y;return a.forEach(u=>{const p=[...u].sort((y,w)=>y.position.x-w.position.x);for(let y=1;y<p.length;y++){const w=p[y-1],N=p[y];let b=g(w,f[w.id]),k=g(N,f[N.id]);if(h(b,k)){const I=b.y+b.height-k.y+t;N.data.nodeType!=="feature"?(f[N.id]+=I,k=g(N,f[N.id])):w.data.nodeType!=="feature"&&(f[w.id]+=I,b=g(w,f[w.id]))}}}),e.forEach(u=>{if(u.data.nodeType==="feature")return;const p=e.filter(y=>y.data.nodeType==="feature"&&Z(y,u,i));for(const y of p){const w=g(u,f[u.id]),N=g(y,f[y.id]);if(h(w,N)){const b=N.y+N.height-w.y+t;f[u.id]+=b}}}),f},V=(e,t)=>e.split(/(\*\*[^*]+\*\*|\*[^*]+\*)/g).map((a,o)=>{const n=`${t}-${String(o)}-${a}`;if(a.startsWith("**")&&a.endsWith("**")){const r=a.slice(2,-2);return x.jsx("strong",{children:r},`b-${n}`)}if(a.startsWith("*")&&a.endsWith("*")){const r=a.slice(1,-1);return x.jsx("em",{children:r},`i-${n}`)}return x.jsx(de.Fragment,{children:a},`t-${n}`)}),aa=e=>{const t=e.replace(/\r\n/g,`
`).split(/\n/),i=[],a=[];let o=[];const n=/^(#+)\s+(.*)$/,r=()=>{if(o.length===0)return;const l=i.length,m=o.map((g,f)=>{const h=`p-${String(l)}-${String(f)}`,u=V(g,h),p=f<o.length-1?x.jsx("br",{}):null;return x.jsxs(de.Fragment,{children:[u,p]},h)});i.push(x.jsx("p",{children:m},`p-${String(l)}`)),o=[]},s=()=>{const l=a.pop();if(!l)return;const{items:m,level:g}=l,f=`ul-${String(g)}-${String(i.length)}`,h=x.jsx("ul",{className:"list-disc list-inside ml-4 space-y-1",children:m},f);a.length===0?i.push(h):a[a.length-1].items.push(h)},c=l=>{for(;a.length>l+1;)s()},d=/^(\s*)\*\s+(.*)$/;return t.forEach(l=>{if(l.trim()==="--- torn ---"){r(),c(-1),i.push(x.jsx("hr",{"aria-hidden":"true",className:"torn-divider"},`torn-${String(i.length)}`));return}const m=n.exec(l);if(m){r(),c(-1);const f=m[2],h=`h-${String(i.length)}`,u=V(f,h);i.push(x.jsx("p",{children:x.jsx("strong",{children:u})},h));return}const g=d.exec(l);if(g){r();const f=g[1].length,h=Math.floor(f/2);for(c(h);a.length<=h;)a.push({level:a.length,items:[]});const u=g[2],p=`li-${String(h)}-${String(a[h].items.length)}`,y=V(u,p);a[h].items.push(x.jsx("li",{children:y},p))}else l.trim()===""?(r(),c(-1)):o.push(l)}),r(),c(-1),i};export{In as $,Pn as A,Rn as B,Fn as C,Tn as D,D as E,Vn as F,Qn as G,qn as H,Hn as I,Sn as J,Kn as K,Yn as L,Xn as M,hn as N,Be as O,Ct as P,le as Q,ce as R,He as S,Zn as T,Jn as U,un as V,on as W,Gn as X,Nn as Y,kn as Z,wn as _,An as a,bn as a0,vn as a1,pn as a2,fn as a3,H as a4,ea as a5,ta as a6,na as a7,Z as a8,Xt as a9,ie as aa,Zt as ab,en as ac,ln as ad,aa as ae,It as af,jn as ag,X as ah,Bn as ai,ut as aj,G as b,cn as c,rn as d,mn as e,_n as f,dn as g,Un as h,gn as i,yn as j,me as k,$n as l,xn as m,En as n,sn as o,Xe as p,ht as q,Cn as r,Je as s,Ln as t,Mn as u,Dn as v,On as w,Wn as x,Ge as y,zn as z};
